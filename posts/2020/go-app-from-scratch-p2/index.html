<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Go RESTful API from scratch pt.2 - Sir</title><meta name="Description" content=""><meta property="og:title" content="Go RESTful API from scratch pt.2" />
<meta property="og:description" content="In this part, we will build a RESTful API server and wrap it in Docker. After that, we&#39;ll deploy it on GKE and start build our CI/CD pipeline for the whole project.
Import Environment Variables Using environment variables to define our database parameters is a better way. There are several reasons that we should not hard code our parameters:
Security
I have seen a lot of cases that people upload their credentials or their database information to Github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.leewei.co/posts/2020/go-app-from-scratch-p2/" />
<meta property="article:published_time" content="2020-06-21T08:32:11+08:00" />
<meta property="article:modified_time" content="2020-06-21T08:32:11+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go RESTful API from scratch pt.2"/>
<meta name="twitter:description" content="In this part, we will build a RESTful API server and wrap it in Docker. After that, we&#39;ll deploy it on GKE and start build our CI/CD pipeline for the whole project.
Import Environment Variables Using environment variables to define our database parameters is a better way. There are several reasons that we should not hard code our parameters:
Security
I have seen a lot of cases that people upload their credentials or their database information to Github."/>
<meta name="application-name" content="Sir">
<meta name="apple-mobile-web-app-title" content="Sir"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.leewei.co/posts/2020/go-app-from-scratch-p2/" /><link rel="prev" href="https://www.leewei.co/posts/2020/dns-brief-records/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Go RESTful API from scratch pt.2",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.leewei.co\/posts\/2020\/go-app-from-scratch-p2\/"
        },"genre": "posts","keywords": "Go, App, RESTful, Docker","wordcount":  935 ,
        "url": "https:\/\/www.leewei.co\/posts\/2020\/go-app-from-scratch-p2\/","datePublished": "2020-06-21T08:32:11+08:00","dateModified": "2020-06-21T08:32:11+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","author": {
                "@type": "Person",
                "name": "Lee Wei"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Sir">Sir</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/tags/"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Sir">Sir</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/tags/" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Go RESTful API from scratch pt.2</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Lee Wei</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-06-21>2020-06-21</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>&nbsp;about 935 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;5 min&nbsp;</div>
        </div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#import-environment-variables">Import Environment Variables</a></li>
    <li><a href="#create-a-http-handler">Create a HTTP handler</a></li>
    <li><a href="#dockerize-our-go-application">Dockerize our Go application</a>
      <ul>
        <li><a href="#what-is-docker">What is Docker?</a></li>
        <li><a href="#why-do-we-need-docker-containers">Why do we need Docker containers?</a></li>
        <li><a href="#dockerfile-and-docker-image">Dockerfile and Docker Image</a></li>
        <li><a href="#write-a-docker-file-for-our-go-application">Write a Docker file for our Go application</a></li>
      </ul>
    </li>
    <li><a href="#what-we-have-accomplished">What we have accomplished!</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>In this part, we will build a RESTful API server and wrap it in Docker.
After that, we'll deploy it on GKE and start build our CI/CD pipeline for the whole project.</p>
<h2 id="import-environment-variables">Import Environment Variables</h2>
<p>Using environment variables to define our database parameters is a better way.
There are several reasons that we should not hard code our parameters:</p>
<p><strong>Security</strong></p>
<p>I have seen a lot of cases that people upload their credentials or their database information to Github. The result can be a disaster. Trust me, I've been there. lol</p>
<p>By using environment variables, user can create a env file when deploying their services.
After successfully deployed their services, user can remove the env file.</p>
<p>!Please don't upload your credentials, password, database configurations on Github!</p>
<p><strong>Flexibility</strong></p>
<p>We might face a time when we need to migrate our database or change the password.
Hard coded parameters are hard to find and change.
It is also easier to test our program with the convenience of environment variables.</p>
<p>Create a file <code>config.env</code> and fill the following variables in the our root directory(/go-api/config.env).</p>
<pre><code class="language-env" data-lang="env">HTTP_PORT:8080
PG_HOST:&quot;localhost&quot;
PG_PORT:5432
PG_USER:&quot;postgres&quot;
PG_PWD:&quot;123456&quot;
PG_DB:&quot;db&quot;
</code></pre><p>Using this package <a href="https://www.github.com/joho/godotenv" target="_blank" rel="noopener noreffer">godotfile</a>, we can load the envs in <code>config.env</code> to our program. We change our <code>initDB</code> function to the following.</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">initDB</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">godotenv</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="s">&#34;config.env&#34;</span><span class="p">)</span>

	<span class="nx">dbHost</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PG_HOST&#34;</span><span class="p">)</span>
	<span class="nx">dbPort</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PG_PORT&#34;</span><span class="p">)</span>
	<span class="nx">dbUser</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PG_USER&#34;</span><span class="p">)</span>
	<span class="nx">dbPwd</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PG_PWD&#34;</span><span class="p">)</span>
	<span class="nx">dbName</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PG_DB&#34;</span><span class="p">)</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><h2 id="create-a-http-handler">Create a HTTP handler</h2>
<p>Add a new hellowWorld function for responding our request to the api.
Add a new handler function for a specfic path <code>/v1/api/</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-Go" data-lang="Go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">initDB</span><span class="p">(</span><span class="p">)</span>
	
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">`</span><span class="s">/v1/api/</span><span class="s">`</span><span class="p">,</span> <span class="nx">helloWorld</span><span class="p">)</span>
	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">helloWorld</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello Go api&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Test our application by run <code>go run main.go</code>, we'll see our http server run on port 8080.
The port number match the one we configure in <code>config.env</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ go run main.go
2020/06/21 16:01:57 HTTP server running on port :8080
</code></pre></div><p>Open another terminal window and check our local endpoint using <code>curl</code> command.
We should get the content in our helloWorld function.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ curl http://localhost:8080/v1/api/
Hello Go api
</code></pre></div><h2 id="dockerize-our-go-application">Dockerize our Go application</h2>
<h3 id="what-is-docker">What is Docker?</h3>
<p>Docker is a software platform for building and delivering application on containers.</p>
<p>Docker Engine is the software that hosts the containers.</p>
<h3 id="why-do-we-need-docker-containers">Why do we need Docker containers?</h3>
<p>The purpose of container is to make sure our application run perfectly in different execution environment.
Think of a Docker as virtual machine with all of your applications and dependencies,
but with the least needed resource in it.</p>
<p>Virtual machines also can keep application isolated from other, but virtual machines are too <del>fat</del> bulky.
Each virtual machines require its own OS, it is typically GB in size.</p>
<p>Contrast of virtual machines, Docker containers are light-weighted and start up almost immediately.</p>
<h3 id="dockerfile-and-docker-image">Dockerfile and Docker Image</h3>
<p>Dockerfile is a text file that describes the resources that the container needs and what the container will do once we run it.</p>
<p>Docker Image is a portable file that contains the specification of the container.
Docker Image is built based on the instructions of the Dockerfile.</p>
<p>More detail for Docker can checkout this awesome <a href="https://www.infoworld.com/article/3204171/what-is-docker-the-spark-for-the-container-revolution.html" target="_blank" rel="noopener noreffer">blog post</a>. ðŸ˜†</p>
<h3 id="write-a-docker-file-for-our-go-application">Write a Docker file for our Go application</h3>
<p>First, create a file <code>Dockerfile</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ touch Dockerfile
$ vim Dockerfile
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="c"># golang:alpine is 370MB</span><span class="err">
</span><span class="err"></span><span class="c"># golang:1.13 is 803MB</span><span class="err">
</span><span class="err"></span><span class="c"># Of course we will choose golang:alpine, we want our Docker image to be as small as possible</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> golang:alpine AS builder</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Set necessary environmet variables needed for our image</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on <span class="se">\
</span><span class="se"></span>    <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">GOOS</span><span class="o">=</span>linux <span class="se">\
</span><span class="se"></span>    <span class="nv">GOARCH</span><span class="o">=</span>amd64

<span class="c"># Set our building directory</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /build</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Copy and download dependency using go mod</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . . <span class="err">
</span><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Build our go code into binary</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go build -o main .<span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Build our final image using an explicitly empty image, scratch</span><span class="err">
</span><span class="err"></span><span class="c"># Our final Docker image will be extremely small because of using this.</span><span class="err">
</span><span class="err"></span><span class="c"># However, if we need to debug our running docker image, I recommend using the alpine image.</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch </span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Set our execution directory and copy our binary, config.env</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /build/main /app/main<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /build/config.env /app/config.env<span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Expose our HTTP server to port 8080</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8080</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="c"># Command to run when starting the container</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/app/main&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><p>Build our Docker image</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ docker build -t go-api .
Sending build context to Docker daemon  62.98kB
Step 1/12 : FROM golang:alpine AS builder
 ---&gt; 3289bf11c284
Step 2/12 : ENV <span class="nv">GO111MODULE</span><span class="o">=</span>on     <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span>     <span class="nv">GOOS</span><span class="o">=</span>linux     <span class="nv">GOARCH</span><span class="o">=</span>amd64
 ---&gt; Using cache
 ---&gt; 18da252a7fe0
Step 3/12 : WORKDIR /build
 ---&gt; Using cache
 ---&gt; 91a3be9b1431
Step 4/12 : COPY . .
 ---&gt; 086213aafe58
Step 5/12 : RUN go mod download
 ---&gt; Running in 72883c948f47
Removing intermediate container 72883c948f47
 ---&gt; ad5f21485b73
Step 6/12 : RUN go build -o main .
 ---&gt; Running in fe23700571c1
Removing intermediate container fe23700571c1
 ---&gt; 664c72a6f7e2
Step 7/12 : FROM scratch
 ---&gt;
Step 8/12 : WORKDIR /app
 ---&gt; Using cache
 ---&gt; 9d8200f80039
Step 9/12 : COPY --from<span class="o">=</span>builder /build/main /app/main
 ---&gt; Using cache
 ---&gt; 9eba303f2d1f
Step 10/12 : COPY --from<span class="o">=</span>builder /build/config.env /app/config.env
 ---&gt; 2928f50b391a
Step 11/12 : EXPOSE <span class="m">8080</span>
 ---&gt; Running in 649d752ee6be
Removing intermediate container 649d752ee6be
 ---&gt; 73e104ae813c
Step 12/12 : CMD <span class="o">[</span><span class="s2">&#34;/app/main&#34;</span><span class="o">]</span>
 ---&gt; Running in d3dff84b3998
Removing intermediate container d3dff84b3998
 ---&gt; 22c860bf60f0
Successfully built 22c860bf60f0
Successfully tagged go-api:latest
</code></pre></div><p>After successfully building our docker image, we can run it locally.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ docker run --rm  -p 8080:8080 go-api
2020/06/21 11:08:34 HTTP server running on port :8080
</code></pre></div><p>Open another terminal to test our api endpoint</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ curl http://localhost:8080/v1/api/
Hello Go api
</code></pre></div><p>This is the structure of our current directory</p>
<pre><code>/sir/go-api
|- config.env
|- Dockerfile
|- go.mod
|- go.sum
|- main.go
</code></pre><h2 id="what-we-have-accomplished">What we have accomplished!</h2>
<ul>
<li>Add a http handler</li>
<li>Know the basic knowledge for Docker</li>
<li>Learn how to write a Dockerfile</li>
<li>Build Docker image</li>
<li>Run the Docker image locally</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-06-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go/">Go</a>,&nbsp;<a href="/tags/app/">App</a>,&nbsp;<a href="/tags/restful/">RESTful</a>,&nbsp;<a href="/tags/docker/">Docker</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2020/dns-brief-records/" class="prev" rel="prev" title="DNS(Domain Name System) Overview"><i class="fas fa-angle-left fa-fw"></i>DNS(Domain Name System) Overview</a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.62.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.8"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Lee Wei</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://https-www-leewei-co.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
