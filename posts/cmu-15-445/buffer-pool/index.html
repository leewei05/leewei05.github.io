<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>CMU Databases Systems: 05 Buffer Pool &amp; Memory Management - Sir</title><meta name="Description" content=""><meta property="og:title" content="CMU Databases Systems: 05 Buffer Pool &amp; Memory Management" />
<meta property="og:description" content="Database Storage  Spatial Control  where to write pages on disk keep pages that are often used together physically as close as possible   Temporal Control  when to read pages into memory, when to write pages to disk minimize the number of stalls from having to read data from disk    Locks vs Latches  Locks  Protect the database logical contents (e.g., tuples, tables, databases) from other transactions Held for transaction duration Need to be able to rollback changes   Latches(It is called Mutex or Locks in the Operating System world)  Protects the critical sections of the DBMS’s internal data structures from other threads Held for operation duration Do not need to be able to rollback changes    Buffer Pool Manager Buffer pool (buffer cache) is an array of fixed-size pages." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.leewei.co/posts/cmu-15-445/buffer-pool/" />
<meta property="article:published_time" content="2020-05-17T11:06:48+08:00" />
<meta property="article:modified_time" content="2020-05-17T11:06:48+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CMU Databases Systems: 05 Buffer Pool &amp; Memory Management"/>
<meta name="twitter:description" content="Database Storage  Spatial Control  where to write pages on disk keep pages that are often used together physically as close as possible   Temporal Control  when to read pages into memory, when to write pages to disk minimize the number of stalls from having to read data from disk    Locks vs Latches  Locks  Protect the database logical contents (e.g., tuples, tables, databases) from other transactions Held for transaction duration Need to be able to rollback changes   Latches(It is called Mutex or Locks in the Operating System world)  Protects the critical sections of the DBMS’s internal data structures from other threads Held for operation duration Do not need to be able to rollback changes    Buffer Pool Manager Buffer pool (buffer cache) is an array of fixed-size pages."/>
<meta name="application-name" content="Sir">
<meta name="apple-mobile-web-app-title" content="Sir"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.leewei.co/posts/cmu-15-445/buffer-pool/" /><link rel="prev" href="https://www.leewei.co/posts/cmu-15-445/database-storage-02/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CMU Databases Systems: 05 Buffer Pool \u0026 Memory Management",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.leewei.co\/posts\/cmu-15-445\/buffer-pool\/"
        },"genre": "posts","keywords": "CMU, 15-445","wordcount":  832 ,
        "url": "https:\/\/www.leewei.co\/posts\/cmu-15-445\/buffer-pool\/","datePublished": "2020-05-17T11:06:48+08:00","dateModified": "2020-05-17T11:06:48+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","author": {
                "@type": "Person",
                "name": "Lee Wei"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Sir">Sir</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/tags/"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Sir">Sir</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/tags/" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">CMU Databases Systems: 05 Buffer Pool &amp; Memory Management</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Lee Wei</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-05-17>2020-05-17</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>&nbsp;about 832 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 min&nbsp;</div>
        </div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#database-storage">Database Storage</a></li>
    <li><a href="#locks-vs-latches">Locks vs Latches</a></li>
    <li><a href="#buffer-pool-manager">Buffer Pool Manager</a>
      <ul>
        <li><a href="#buffer-pool-metadata">Buffer Pool metadata</a></li>
        <li><a href="#buffer-pool-optimizations">Buffer Pool Optimizations</a></li>
        <li><a href="#buffer-pool-bypass">Buffer Pool Bypass</a></li>
        <li><a href="#allocations-policies">Allocations Policies</a></li>
        <li><a href="#os-page-cache">OS Page Cache</a></li>
      </ul>
    </li>
    <li><a href="#buffer-pool-replacement-policies">Buffer Pool Replacement Policies</a>
      <ul>
        <li><a href="#least-recently-used-lru">Least Recently Used (LRU)</a></li>
        <li><a href="#clock">CLOCK</a></li>
        <li><a href="#problems-with-lru-and-clock">Problems with LRU and CLOCK</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="database-storage">Database Storage</h2>
<ul>
<li>Spatial Control
<ul>
<li>where to write pages on disk</li>
<li>keep pages that are often used together physically as close as possible</li>
</ul>
</li>
<li>Temporal Control
<ul>
<li>when to read pages into memory, when to write pages to disk</li>
<li>minimize the number of stalls from having to read data from disk</li>
</ul>
</li>
</ul>
<h2 id="locks-vs-latches">Locks vs Latches</h2>
<ul>
<li>Locks
<ul>
<li>Protect the database logical contents (e.g., tuples, tables, databases) from other transactions</li>
<li>Held for transaction duration</li>
<li>Need to be able to rollback changes</li>
</ul>
</li>
<li>Latches(It is called Mutex or Locks in the Operating System world)
<ul>
<li>Protects the critical sections of the DBMS’s internal data structures from other threads</li>
<li>Held for operation duration</li>
<li>Do not need to be able to rollback changes</li>
</ul>
</li>
</ul>
<h2 id="buffer-pool-manager">Buffer Pool Manager</h2>
<p>Buffer pool (buffer cache) is an array of fixed-size pages. An array entry is called <code>frame</code>.</p>
<p>After executing a query to the DBMS, execution engine will request data from the buffer pool.
Then, buffer pool will first search the data pages within to see whether if the data requested is in the buffer pool.
If not, the buffer pool will ask the data directory for certain data in the data pages(written in the disk).
Buffer pool will store the data in the memory, in each frame of the buffer pool.
Finally, buffer pool will give the execution engine the pointer of the data page.</p>
<h3 id="buffer-pool-metadata">Buffer Pool metadata</h3>
<ul>
<li><code>Page Table</code>: In-memory hash table that keeps track of pages that are currently in memory. It maps
page ids to frame locations in the buffer pool</li>
<li><code>Dirty-flag</code>: Threads set this flag when it modifies a page. This indicates to storage manager that the page must be written back to disk
<ul>
<li>when a dirty page is safety written, the DBMS can either evict the page or unset the dirty-flag</li>
<li><strong>make sure to write log records before writing dirty pages to disk</strong></li>
</ul>
</li>
<li><code>Pin/Reference Counter</code>: This tracks the number of threads that are currently accessing that page (either reading
or modifying it). A thread has to increment the counter before they access the page. If a page’s count
is greater than zero, then the storage manager is not allowed to evict that page from memory</li>
</ul>
<h3 id="buffer-pool-optimizations">Buffer Pool Optimizations</h3>
<ul>
<li>Multiple Buffer Pools: The DBMS can also have multiple buffer pools for different purposes, e.g. per-table buffer pool, per-page buffer pool. This helps reduce latch contention and improves locality
<ul>
<li>How to identify the data in which buffer pool?
<ul>
<li>Object id: each record will be given an object id, and map the object id to specific buffer pool</li>
<li>Hash id: hash the page id to see which buffer pool to choose</li>
</ul>
</li>
</ul>
</li>
<li>Pre-Fetching: The DBMS can also optimize by pre-fetching pages based on the query plan. Commonly done when accessing pages sequentially.
This will minimize the number of stalls when fetching data pages from disks</li>
<li>Scan Sharing: Query cursors can attach to other cursors and scan pages together
<ul>
<li>queries do not have to be the same, but they can share intermediate results</li>
</ul>
</li>
</ul>
<h3 id="buffer-pool-bypass">Buffer Pool Bypass</h3>
<p>The sequential scan operator will not store fetched data in buffer pool.
DBMS will allocate a small section of memory to run sequential queries.
After finishing the queries, it will just drop the data in the memory.</p>
<p><strong>This mechanism is efficient for running large sequential queries.</strong></p>
<h3 id="allocations-policies">Allocations Policies</h3>
<ul>
<li>Global Policies: How a DBMS should make decisions for all active txns(transactions).</li>
<li>Local Policies: Allocate frames to a specific txn without considering the behavior of concurrent txns</li>
</ul>
<h3 id="os-page-cache">OS Page Cache</h3>
<p>Most DBMSs use direct I/O(O_DIRECT) to bypass the OS's cache.
This will guarantee same DBMSs&rsquo; performance cross different OS platforms.
However, there will be redundant copies of data pages and different eviction policies.</p>
<h2 id="buffer-pool-replacement-policies">Buffer Pool Replacement Policies</h2>
<p>A replacement policy is an algorithm that makes a decision on which pages to
evict from buffer pool when it needs space.</p>
<p>Implementation goals:</p>
<ul>
<li>Correctness</li>
<li>Accuracy</li>
<li>Speed</li>
<li>Meta-data overhead</li>
</ul>
<h3 id="least-recently-used-lru">Least Recently Used (LRU)</h3>
<ul>
<li>maintain a timestamp of when each page was last accessed</li>
<li>DBMS picks the page with the oldest timestamp to evict</li>
</ul>
<h3 id="clock">CLOCK</h3>
<p>Approximation of LRU without needing a separate timestamp per page.</p>
<ul>
<li>Each page has a reference bit</li>
<li>When a page is accessed by queries, set to 1</li>
<li>Organize the pages in a circular buffer with a “clock hand”
<ul>
<li>Upon sweeping check if a pages bit is set to 1. If yes, set to zero, if no, then evict. Clock hand remembers position between evictions</li>
</ul>
</li>
</ul>
<p>This mechanism assumes the page that is not use recently, will not be used in the future.</p>
<h3 id="problems-with-lru-and-clock">Problems with LRU and CLOCK</h3>
<p>LRU and Clock are susceptible to sequential flooding where the buffer pool’s contents are trashed
due to a sequential scan. It may be that the LRU page is actually important due to not tracking meta-data of how a page is used.</p>
<p>Better solutions:</p>
<ul>
<li>LRU-K: Take into account history of the last K references</li>
<li>Priority hints: Allow txns to tell the buffer pool whether page is important or not</li>
<li>Localization: Choose pages to evict on a per txn/query basis</li>
</ul>
<h2 id="summary">Summary</h2>
<p>DBMSs can manage the memory better than the OS.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-05-17</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/cmu/">CMU</a>,&nbsp;<a href="/tags/15-445/">15-445</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cmu-15-445/database-storage-02/" class="prev" rel="prev" title="CMU Databases Systems: 04 Database Storage(pt.2)"><i class="fas fa-angle-left fa-fw"></i>CMU Databases Systems: 04 Database Storage(pt.2)</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.62.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.8"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Lee Wei</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
